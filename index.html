<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Cacophony - For your practice needs</title>    
    
    <script src="./alphaTab.js" crossorigin="use-credentials"></script>
    <script src="./jszip.min.js"></script>
    <link rel="stylesheet" href="./nav.css">

    <style>
      #wrapper {
        overflow-y: auto;
        position: absolute;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 60px;
        background: #cdcdcd;
      }
      .hidden {
        display: none !important;
      }
      #footer {
        width: 100%;
        left: 0;
        position: absolute;
        background: #292929;
        color: white;
        height: 60px;
        bottom: 0;
        display: flex;
      }
      #mainControl, #subControl {
        display: flex;
        align-items: center;
      }
      .control {
        padding: 13px 15px;
      }
      #mainControl img {
        height: 30px;
      }
      #subControl img {
        height: 25px;
        padding: 2.5px 0px;
      }
      #subControl .control.active {
        background: #065d15;
      }
      .control .pause {
        display: none;
      }
      .playing .pause {
        display: block;
      }
      .playing .play {
        display: none;
      }
      #volume {
        display: flex;
        align-items: center;
      }
      #volumeOn {
        position: absolute;
      }
      #volume.muted #volumeOn {
        display: none;
      }
      #volumeSlider {
        margin-left: -25px;
      }
      .control select {
        margin-left: 5px;
        padding: 5px;
      }
      #delay {
        width: 70px;
        padding: 5px;
      }
      #speedSelector {
        width: 70px;
      }
      #trackSelector {
        width: 130px;
      }
      .at-cursor-bar {
        /* Defines the color of the bar background when a bar is played */
        background: rgba(255, 242, 0, 0.25);
      }

      .at-selection div {
        /* Defines the color of the selection background */
        background: rgba(64, 64, 255, 0.1);
      }

      .at-cursor-beat {
        /* Defines the beat cursor */
        background: rgba(64, 64, 255, 0.75);
        width: 3px;
      }

      .at-highlight * {
        /* Defines the color of the music symbols when they are being played (svg) */
        fill: #0078ff;
        stroke: #0078ff;
      }
      #fileSelector {
        width: 50%;
        margin: 10px auto;
      }
      .fileSelectorInput {
        display: flex;
        padding: 10px;
      }
      .fileSelectorInput span {
        width: 100px;
      }
      .fileSelectorSeparator {
        border-bottom: 1px solid gray;
        margin: 10px 0;
      }
      .fileSelectorText {
        padding: 10px;
      }
      .fileSelectorInput button {
        width: 40%;
        margin: 0 5%;
        padding: 10px 0;
      }
    </style>

</head>
<body>
    <div id="nav"></div>

    <div id="wrapper" class="hidden"><div id="alphaTab" data-player="./src/lib/alphaSynth/default.sf2" data-player-offset="[-10, -70]"></div></div>
    <div id="footer" class="hidden">
      <div id="mainControl">
        <audio id="audio"></audio>
        <div id="open" class="control"><img src="./img/open.png"></div>
        <div id="playPause" class="control">
          <img class="play" src="./img/play.png">
          <img class="pause" src="./img/pause.png">
        </div>
      </div>
      <div id="subControl">
        <div id="looping" class="control"><img src="./img/loop.png"></div>
        <div id="volume" class="control">
          <img src="./img/volume-base.png">
          <img id="volumeOn" src="./img/volume.png">
        </div>
        <div id="volumeSlider" class="control">
          <input type="range" min="0" max="100" value="50" class="slider" id="volumeValue">
        </div>
        <div class="control">
          <span>Speed</span>
          <select id="speedSelector">
            <option value="0.25">x0.25</option>
            <option value="0.5">x0.5</option>
            <option value="0.6">x0.6</option>
            <option value="0.7">x0.7</option>
            <option value="0.8">x0.8</option>
            <option value="0.9">x0.9</option>
            <option value="1" selected>x1.0</option>
            <option value="1.1">x1.1</option>
            <option value="1.25">x1.25</option>
            <option value="1.5">x1.5</option>
            <option value="2">x2.0</option>
          </select>
        </div>
        <div class="control">
          <span>Delay</span>
          <input type="number" id="delay">
        </div>
        <div class="control">
          <span>Tracks</span>
          <select id="trackSelector"></select>
        </div>
      </div>
    </div>
    <div id="fileSelector">
      <div class="fileSelectorInput"><span>Import ZIP</span><input type="file" id="zipFile" accept=".zip"></div>
      <div class="fileSelectorSeparator"></div>
      <div class="fileSelectorInput"><span>Sheet</span><input type="file" id="sheetFile" accept=".gp3,.gp4,.gp5,.gpx,.gp,.xml,.cap"></div>
      <div class="fileSelectorInput"><span>Audio</span><input type="file" id="audioFile" accept=".mp3,.ogg"></div>
      <div class="fileSelectorInput"><span>Delay</span><input type="number" id="delaySetting"></div>
      <div class="fileSelectorInput"><span>Volume</span><input type="number" min="0" max="100" id="volumeSetting"></div>
      <div class="fileSelectorSeparator"></div>
      <div class="fileSelectorInput">
        <button id="import">Import</button>
        <button id="export">Export ZIP</button>
      </div>
      <div class="fileSelectorSeparator"></div>
      <div class="fileSelectorText">
        <span>Supported files:</span>
        <ul>
          <li>Guitar Pro 3-5 files (.gp3, .gp4, .gp5)</li>
          <li>Guitar Pro 6 files (.gpx)</li>
          <li>Guitar Pro 7 files (.gp)</li>
          <li>MusicXML files (.xml)</li>
          <li>CapXML files (.cap)</li>
          <li>MP3 or OGG files</li>
        </ul>
      </div>
    </div>

    <script type="text/javascript">
      const loaded = {
        sheet: false,
        audio: false
      }
      const trackSelectorDiv = document.querySelector("#trackSelector");
      const currentTrackDiv = document.querySelector("#currentTrack");
      const playPauseDiv = document.querySelector("#playPause");
      const importZip = document.querySelector("#zipFile");
      const importSheet = document.querySelector("#sheetFile");
      const importAudio = document.querySelector("#audioFile");
      const importDelay = document.querySelector("#delaySetting");
      const importVolume = document.querySelector("#volumeSetting");
      const importBtn = document.querySelector("#import");
      const exportBtn = document.querySelector("#export");
      const loopDiv = document.querySelector("#looping");
      const speedSelectorDiv = document.querySelector("#speedSelector");
      const volumeDiv = document.querySelector("#volume");
      const volumeValueDiv = document.querySelector("#volumeValue");
      const delayDiv = document.querySelector("#delay");
      const audio = document.querySelector("#audio");        
      const at = document.querySelector('#alphaTab');
      const wrapper = document.querySelector("#wrapper");

      let delay = 0;

      api = new alphaTab.AlphaTabApi(at, {
        player: { 
          enablePlayer: true,
          //soundFont: 'https://cdn.jsdelivr.net/npm/@coderline/alphatab@latest/dist/soundfont/sonivox.sf2',
          scrollElement: wrapper
        }
      });

      api.renderStarted.on(() => {
        loaded.sheet = false;
      })
      api.renderFinished.on(() => {
        loaded.sheet = true;
      });
      api.scoreLoaded.on(() => {
        trackSelectorDiv.innerHTML = "";
        api.score.tracks.forEach(i => { 
          trackSelectorDiv.innerHTML += `<option value="${i.index}">${i.name}</option>`
        })
      });
      api.beatMouseUp.on(beat => {
        audio.currentTime = (getAccurateTime(beat.absolutePlaybackStart) + delay) / 1000;
      })
      api.playerStateChanged.on(args => {
        if (args.state) playPauseDiv.classList.add("playing");
        else {
          audio.pause();
          playPauseDiv.classList.remove("playing");
        }
      })
      api.playerFinished.on(() => { 
        if (api.isLooping) audio.currentTime = (getAccurateTime(api.playbackRange.startTick) + delay) / 1000;
      })
      trackSelectorDiv.onchange = () => {
        if (loaded.sheet) {
          loaded.sheet = false;
          api.renderTracks([api.score.tracks[trackSelectorDiv.value]]);
        }
      }
      playPauseDiv.onclick = () => {
        play();
      };
      loopDiv.onclick = () => {
        loopDiv.classList.toggle("active");
        api.isLooping = loopDiv.classList.contains("active");
      }
      document.querySelector("#open").onclick = () => {
        wrapper.classList.toggle("hidden");
      }
      speedSelectorDiv.onchange = () => {
        api.playbackSpeed = speedSelectorDiv.value;
        audio.playbackRate = speedSelectorDiv.value;
        audio.currentTime = (api.timePosition + delay) / 1000;
      }
      delayDiv.onchange = () => { delay = parseInt(delayDiv.value) }
      exportBtn.onclick = () => {
        if (!importSheet.files.length) return error("Sheet file not found");
        if (!importAudio.files.length) return error("Audio file not found");

        let zip = new JSZip();
        zip.file(importSheet.files[0].name, importSheet.files[0]);
        zip.file(importAudio.files[0].name, importAudio.files[0]);
        zip.file("config.json", JSON.stringify({
          delay: importDelay.value,
          volume: importVolume.value
        }));
        zip.generateAsync({type: "blob"}).then(blob => {
          saveAs(blob, importSheet.files[0].name.replace(/\.[^.]+$/, ".zip"));
        })
      }
      importBtn.onclick = () => {
        if (importZip.files.length) {
          JSZip.loadAsync(importZip.files[0]).then(zip => {
            let sheetFile = zip.file(/\.gp3|\.gp4|\.gp5|\.gpx|\.gp|\.xml|\.cap/)[0];
            let audioFile = zip.file(/\.mp3|\.ogg/)[0];
            let configFile = zip.file(/\.json/)[0];
            if (!sheetFile) return error("Sheet file not found");
            if (!audioFile) return error("Audio file not found");

            let promises = [sheetFile.async("arraybuffer"), audioFile.async("blob")];
            if (configFile) promises.push(configFile.async("text"));
            
            Promise.all(promises).then(load);
          });
        } else {
          if (!importSheet.files.length) return error("Sheet file not found");
          if (!importAudio.files.length) return error("Audio file not found");

          delay = parseInt(importDelay.value);
          delayDiv.value = importDelay.value;

          audio.volume = importVolume.value / 100;
          volumeValueDiv.value = importVolume.value;

          let fr = new FileReader();
          fr.onload = () => { load([fr.result, importAudio.files[0]]) }
          fr.readAsArrayBuffer(importSheet.files[0]);
        }
      }
      function load(data) {
        if (data[2]) {
          let config = JSON.parse(data[2]);

          delay = config.delay;
          delayDiv.value = config.delay;

          audio.volume = config.volume / 100;
          volumeValueDiv.value = config.volume;
        }
        wrapper.classList.remove("hidden");
        document.querySelector("#footer").classList.remove("hidden");
        api.load(data[0]);
        audio.src = window.URL.createObjectURL(data[1]);
      }
      volumeDiv.onclick = () => {
        volumeDiv.classList.toggle("muted");
        volumeValueDiv.disabled = volumeDiv.classList.contains("muted");
        audio.muted = volumeDiv.classList.contains("muted");
      }
      volumeValueDiv.onchange = () => {
        audio.volume = volumeValueDiv.value / 100;
      }
      audio.oncanplaythrough = () => {
        loaded.audio = true;
      }
      function getAccurateTime(midiTick) { return midiTick * 60000 / (87 * 960) }
      function play() {
        console.log('a');
        if (loaded.sheet && loaded.audio) {
          if (api.playerState) {
            api.playPause();
            audio.pause();
          } else {
            if (api.timePosition == 0) {
              if (delay < 0) {
                audio.play();
                setTimeout(() => { api.playPause(); }, delay);
              } else if (delay > 0) {
                api.playPause()
                setTimeout(() => { audio.play(); }, delay);
              } else {
                audio.play();
                api.playPause();
              }
            } else {
              api.playPause();
              audio.currentTime = (api.timePosition + delay) / 1000;
              audio.play();
            }
          }
        }
      }
      document.onkeydown = e => { 
        if (loaded.audio && loaded.sheet) {
          if (e.code == "Space") play();
          else if (e.code == "ArrowLeft") {
            let currentMasterBar = api._currentBeat.currentBeatLookup.masterBar.masterBar;
            if (currentMasterBar.previousMasterBar) currentMasterBar = currentMasterBar.previousMasterBar.start;
            else currentMasterBar = currentMasterBar.start;
            api.tickPosition = currentMasterBar;
            audio.currentTime = (getAccurateTime(api.tickPosition) + delay) / 1000;
          }
          else if (e.code == "ArrowRight") {
            let currentMasterBar = api._currentBeat.currentBeatLookup.masterBar;
            if (currentMasterBar.nextMasterBar) currentMasterBar = currentMasterBar.nextMasterBar.start;
            else currentMasterBar = currentMasterBar.start;
            api.tickPosition = currentMasterBar;
            audio.currentTime = (getAccurateTime(api.tickPosition) + delay) / 1000;}
        }
      }
    </script>
    <script src="./nav.js"></script>
</body>
</html>   